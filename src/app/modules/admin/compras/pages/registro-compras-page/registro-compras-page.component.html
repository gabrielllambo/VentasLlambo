<div class="flex flex-col flex-auto w-full">
  <div class="flex flex-wrap w-full max-w-screen-xl mx-auto p-6 md:p-8">
    <div class="flex items-center justify-between w-full">
      <h2 class="text-2xl md:text-3xl font-semibold tracking-tight leading-8">Nueva Compra</h2>
    </div>

    <!-- Buscador de productos -->
    <div class="w-full xl:col-span-2 mt-6 relative">
      <div class="relative">
        <input maxlength="50" [disabled]="isBuscandoProductosDisabled || isCallingInsertService" type="text"
          [(ngModel)]="parametroBusquedaProducto" (keyup.enter)="keyupEnterProductos($event)"
          (input)="filtrarProductos($event)" placeholder="Buscar Producto"
          class="w-full p-3 pl-10 border border-gray-300 rounded-xl bg-card shadow focus:ring focus:ring-primary-300 focus:outline-none placeholder:text-gray-500">
        <mat-icon class="absolute left-3 top-3 text-gray-500" [svgIcon]="'heroicons_mini:magnifying-glass'"
          (click)="keyupEnterProductos($event)"></mat-icon>
      </div>

      <div *ngIf="allProductoDataSource.data.length > 0"
        class="absolute w-auto mt-2 bg-white shadow-lg rounded-xl border border-gray-300 overflow-hidden max-h-72 overflow-y-auto z-50 transition-all duration-200 ease-in-out">
        <table class="w-auto text-left">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-2 text-sm font-semibold">Imagen</th>
              <th class="p-2 text-sm font-semibold">Código</th>
              <th class="p-2 text-sm font-semibold">Nombre</th>
              <th class="p-2 text-sm font-semibold">Stock</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let producto of allProductoDataSource.data" class="cursor-pointer hover:bg-gray-200"
              (click)="seleccionarProducto(producto)">
              <td class="min-w-10">
                <div class="flex items-center">
                  <div class="relative flex items-center justify-center w-12 h-12 mr-6 rounded overflow-hidden border">
                    <img *ngIf="producto.urlFoto" [alt]="'Imagen de ' + producto.nombre" [src]="producto.urlFoto"
                      class="w-full h-full object-cover">
                    <div *ngIf="!producto.urlFoto"
                      class="flex items-center justify-center w-full h-full text-xs font-semibold leading-none text-center uppercase bg-gray-200">
                      SIN IMAGEN
                    </div>
                  </div>
                </div>
              </td>
              <td class="p-2 text-sm">{{ producto.codigo }}</td>
              <td class="p-2 text-sm">{{ producto.nombre }}</td>
              <td class="p-2 text-sm">
                <span
                  class="inline-flex items-center font-bold text-xs px-2.5 py-0.5 rounded-full tracking-wide uppercase"
                  [ngClass]="{'bg-red-200 text-red-800': producto?.stock <= 0,
                              'bg-orange-200 text-orange-800': producto?.stock > 0 && producto?.stock <= 5,
                              'bg-green-200 text-green-800': producto?.stock > 5 }">
                  <span class="leading-relaxed whitespace-nowrap">{{producto?.stock}}</span>
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Categorías -->
    <div class="w-full xl:col-span-2 mt-6 relative">
      <mat-button-toggle-group class="flex flex-wrap -m-2" (change)="onSelectCategoryProduct($event)">
        <ng-container *ngFor="let category of allCategoriesDataSource">
          <mat-button-toggle class="m-2" [value]="category">
            <span class="text-secondary">{{category.nombre}}</span>
            <span class="ml-1.5 font-medium text-secondary">({{category.cantidadProductos}})</span>
          </mat-button-toggle>
        </ng-container>
      </mat-button-toggle-group>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-4 gap-8 w-full mt-8">
      <!-- Tabla de Productos Seleccionados -->
      <div class="xl:col-span-3 flex flex-col flex-auto bg-card shadow rounded-2xl overflow-hidden px-6 pt-6 pb-10">
        <div class="overflow-x-auto md:overflow-visible mx-6">
          <table *ngIf="lstProductosSeleccionados?.data.length > 0" class="w-full bg-transparent" mat-table matSort
            [dataSource]="lstProductosSeleccionados" [trackBy]="trackByFn">
            <!-- Imagen, nombre, stock similares -->
            <ng-container matColumnDef="foto">
              <th mat-header-cell *matHeaderCellDef>Imagen</th>
              <td mat-cell *matCellDef="let producto" class="min-w-10">
                <div class="flex items-center">
                  <div class="relative flex items-center justify-center w-12 h-12 mr-6 rounded overflow-hidden border">
                    <img *ngIf="producto?.urlFoto" [alt]="'Imagen de ' +producto?.nombre" [src]="producto?.urlFoto"
                      class="w-full h-full object-cover">
                    <div *ngIf="!producto?.urlFoto"
                      class="flex items-center justify-center w-full h-full text-xs font-semibold leading-none text-center uppercase bg-gray-200">
                      SIN IMAGEN
                    </div>
                  </div>
                </div>
              </td>
            </ng-container>
            <ng-container matColumnDef="nombre">
              <th mat-header-cell mat-sort-header *matHeaderCellDef>
                Nombre
              </th>
              <td mat-cell *matCellDef="let producto" class="min-w-30">
                <span class="flex items-center">
                  <span class="ml-3 break-words max-w-[150px]">{{producto.nombre}}</span>
                </span>
              </td>
            </ng-container>
            <!-- Stock -->
            <ng-container matColumnDef="stock">
              <th mat-header-cell mat-sort-header *matHeaderCellDef class="text-center">
                Stock
              </th>
              <td mat-cell *matCellDef="let producto" class="min-w-10 text-center">
                <span
                  class="inline-flex items-center font-bold text-xs px-2.5 py-0.5 rounded-full tracking-wide uppercase"
                  [ngClass]="{
                        'bg-red-200 text-red-800 dark:bg-red-600 dark:text-red-50': producto?.stock <= 0,
                        'bg-orange-200 text-orange-800 dark:bg-orange-600 dark:text-orange-50': producto?.stock > 0 && producto?.stock <= 5,
                        'bg-green-200 text-green-800 dark:bg-green-600 dark:text-green-50': producto?.stock > 5
                        }">
                  <span class="leading-relaxed whitespace-nowrap">{{producto?.stock}}</span>
                </span>
              </td>
            </ng-container>
            <!-- Precio Compra (editable) -->
            <ng-container matColumnDef="precioCompra">
              <th mat-header-cell *matHeaderCellDef class="min-w-20 text-center">
                Precio Compra
              </th>
              <td mat-cell *matCellDef="let producto; let i = index">
                <input type="number" min="0" step="0.01" [(ngModel)]="lstProductosSeleccionados.data[i].precioCompra"
                  (input)="calcularTotalCompra()" class="w-24 text-center border rounded-md p-1" />
              </td>
            </ng-container>

            <!-- Cantidad y Total (precioCosto * cantidad) -->
            <ng-container matColumnDef="cantidad">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let producto">
                <div class="flex items-center space-x-2">
                  <button mat-icon-button color="primary" [disabled]="isCallingInsertService"
                    (click)="disminuirCantidad(producto)"><mat-icon>remove</mat-icon></button>
                  <input type="number" [disabled]="isCallingInsertService" [(ngModel)]="producto.cantidad"
                    class="w-16 text-center border rounded-md" min="1" readonly>
                  <button mat-icon-button color="primary" [disabled]="isCallingInsertService"
                    (click)="aumentarCantidad(producto)"><mat-icon>add</mat-icon></button>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="total">
              <th mat-header-cell mat-sort-header *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let producto">
                <span style="color: #056DB6;" class="pr-6 w-auto h-auto rounded-full">
                  {{ calcularTotalProducto(producto) | currency: monedaInfo.codigoMoneda:'code':'':
                  monedaInfo.cultureInfo }}
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef> Acciones </th>
              <td mat-cell *matCellDef="let producto">
                <button mat-icon-button color="warn" (click)="quitarProducto(producto)" class="p-1"
                  [disabled]="disabledAcciones || isCallingInsertService">
                  <mat-icon svgIcon="feather:trash-2"></mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="productoTableColumns"></tr>
            <tr class="order-row h-16" mat-row *matRowDef="let row; columns: productoTableColumns;"></tr>
          </table>

          <!-- Cards de productos por categoría (igual que venta) -->
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5 mt-6">
            <div *ngFor="let producto of allProductByCategoryDataSource"
              class="bg-white rounded-2xl shadow-lg p-4 flex flex-col items-center transform transition-transform hover:scale-105 hover:shadow-xl border border-gray-200">
              <div class="w-24 h-24 mb-4 rounded-xl overflow-hidden border border-gray-300">
                <img *ngIf="producto.urlFoto; else noImagen" [src]="producto.urlFoto" [alt]="producto.nombre"
                  class="w-full h-full object-cover">
                <ng-template #noImagen>
                  <div
                    class="flex items-center justify-center w-full h-full text-xs font-semibold text-center uppercase bg-gray-200 text-gray-600">
                    SIN IMAGEN
                  </div>
                </ng-template>
              </div>

              <h3 class="text-base font-semibold text-center text-gray-800">{{ producto.nombre }}</h3>
              <p class="text-sm font-medium text-gray-700 mt-1">
                <span style="color: #056DB6;">{{ producto.precioCosto | currency: monedaInfo.codigoMoneda:'code':'':
                  monedaInfo.cultureInfo }}</span>
              </p>
              <p class="text-xs font-medium mt-1"
                [ngClass]="{'text-red-600': producto.stock <= 0,'text-orange-500': producto.stock > 0 && producto.stock <= 5,'text-green-600': producto.stock > 5}">
                Stock: {{ producto.stock }}
              </p>
              <button [disabled]="isCallingInsertService" (click)="seleccionarProducto(producto)"
                class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-xl shadow hover:bg-blue-700 transition-colors">
                Agregar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel derecho con proveedor, fecha, nota y total -->
      <div class="xl:col-span-1 flex flex-col flex-auto p-6 bg-card rounded-2xl shadow-lg">
        <div class="flex flex-col">
          <div class="grid grid-cols-2 gap-4">
            <div
              class="col-span-2 flex flex-col items-center justify-center py-6 px-4 rounded-2xl bg-green-100 text-green-700">
              <div class="mt-1 text-2xl font-semibold">Total</div>
              <div class="text-4xl font-bold leading-none tracking-tight">
                {{ totalCompra | currency: monedaInfo.codigoMoneda:'code':'': monedaInfo.cultureInfo }}
              </div>
            </div>
          </div>
        </div>

        <form [formGroup]="filtroRegistroComprasForm">
          <div class="flex items-center mt-3">
            <div class="text font-medium tracking-tight">Fecha De Compra</div>
          </div>
          <div class="mt-3 relative">
            <mat-form-field class="w-full">
              <input [disabled]="isCallingInsertService" required (click)="fechaRegistroCompra.open()"
                autocomplete="off" matInput [formControlName]="'fechaRegistroCompra'"
                [matDatetimepicker]="fechaRegistroCompra" autocomplete="false" />
              <mat-datetimepicker-toggle [disabled]="isCallingInsertService" matPrefix
                [for]="fechaRegistroCompra"></mat-datetimepicker-toggle>
              <mat-datetimepicker #fechaRegistroCompra type="datetime" openOnFocus="true"
                timeInterval="5"></mat-datetimepicker>
              <mat-error *ngIf="filtroRegistroComprasForm.get('fechaRegistroCompra').hasError('required')">
                Fecha Compra es requerido
              </mat-error>
            </mat-form-field>
          </div>
        </form>

        <!-- Buscar Proveedor -->
        <div class="flex items-center mt-4">
          <div class="text font-medium tracking-tight">Buscar Proveedor</div>
        </div>
        <div class="mt-3 relative">
          <div class="relative">
            <input type="text" [(ngModel)]="parametroBusquedaProveedor" [disabled]="isCallingInsertService"
              (keyup.enter)="buscarProveedor()" placeholder="RUC o Correo"
              class="w-full p-3 pl-12 border border-gray-300 rounded-xl bg-white shadow focus:ring focus:ring-primary-300 focus:outline-none">
            <mat-icon class="absolute left-3 top-3 text-gray-500 cursor-pointer"
              [svgIcon]="'heroicons_mini:magnifying-glass'" (click)="buscarProveedor()"></mat-icon>
          </div>
        </div>

        <!-- Panel datos proveedor -->
        <div *ngIf="hayProveedor" class="mt-3 p-2 border-t border-gray-300 bg-gray-100 rounded-lg shadow-md">
          <button mat-icon-button color="warn" (click)="quitarProveedor()" class="absolute top-3 right-3"
            [disabled]="isCallingInsertService">
            <mat-icon [svgIcon]="'heroicons_solid:trash'"></mat-icon>
          </button>

          <div class="text-lg font-semibold">{{ proveedorData?.numeroDocumento || 'N/D' }}</div>
          <div class="flex flex-col sm:flex-row sm:items-center mt-3 space-y-2 sm:space-y-0 sm:space-x-4">
            <div class="flex items-center">
              <mat-icon class="icon-size-5 text-primary-500" [svgIcon]="'heroicons_solid:user'"></mat-icon>
              <div class="ml-2 text-md text-gray-700">
                {{ proveedorData?.nombreComercial|| proveedorData?.razonSocial || ''}} {{'|'}} {{
                proveedorData?.correoElectronico || '' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Nota adicional -->
        <div class="flex items-center mt-3">
          <div class="text font-medium tracking-tight">Nota adicional</div>
        </div>
        <div class="mt-3 relative">
          <textarea [disabled]="isCallingInsertService" id="notaAdicional" [(ngModel)]="notaAdicional"
            class="w-full p-3 border border-gray-300 rounded-xl bg-white shadow focus:ring focus:ring-primary-300"
            rows="3" placeholder="Nota adicional"></textarea>
        </div>

        <div class="flex justify-center mt-6">
          <button
            [disabled]="!hayProveedor || isCallingInsertService || lstProductosSeleccionados.data.length == 0 || !filtroRegistroComprasForm.get('fechaRegistroCompra').value"
            (click)="InsertAsync()"
            class="w-full sm:inline-flex ml-3 sm:w-full sm:h-10 sm:items-center sm:justify-center transition duration-300 ease-in-out transform hover:scale-105 hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-300"
            mat-flat-button color="primary" type="button">
            <span *ngIf="!isCallingInsertService">Registrar Compra</span>
            <mat-progress-spinner *ngIf="isCallingInsertService" [diameter]="24"
              [mode]="'indeterminate'"></mat-progress-spinner>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>